#!/bin/bash
#
# Exodus / Cortez Tunnel Kernel Module Installer
#

set -e

MODULE_NAME="cortez_tunnel"
MODULE_FILE="k-module/${MODULE_NAME}.ko"

# --- 0. Parse Group Argument ---
REQUESTED_GROUP="$1"

# --- 1. Root Check ---
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run with sudo or as root." >&2
    exit 1
fi

# --- 2. File Check ---
if [ ! -f "$MODULE_FILE" ]; then
    echo "Error: Module file '$MODULE_FILE' not found in this directory." >&2
    exit 1
fi

# --- 3. Determine Kernel Install Path ---
KERNEL_VER=$(uname -r)
INSTALL_PATH="/lib/modules/${KERNEL_VER}/extra"

echo "Installing $MODULE_FILE for kernel $KERNEL_VER..."

mkdir -p "$INSTALL_PATH"
install -m 644 "$MODULE_FILE" "$INSTALL_PATH/"

echo " -> Running depmod..."
depmod -a

# --- 4. Determine group to use ---
determine_group() {
    # If the user passed an argument, validate it.
    if [ -n "$REQUESTED_GROUP" ]; then
        if getent group "$REQUESTED_GROUP" >/dev/null; then
            echo "$REQUESTED_GROUP"
            return
        else
            echo "Error: group '$REQUESTED_GROUP' does not exist." >&2
            exit 1
        fi
    fi

    # Otherwise: auto-detect a smart default group.
    # We avoid system groups like root, daemon, bin.
    USERNAME=$(logname 2>/dev/null || echo $SUDO_USER)
    USER_GROUPS=$(id -nG "$USERNAME")

    for g in $USER_GROUPS; do
        case "$g" in
            root|daemon|bin|adm|systemd-*|sudo)
                ;;
            *)
                echo "$g"
                return
                ;;
        esac
    done

    # Fallback: use the user's primary group
    id -gn "$USERNAME"
}

GROUP_TO_USE=$(determine_group)

echo "Using group: $GROUP_TO_USE"

# --- 5. Ensure udev rule exists ---
UDEV_RULE="/etc/udev/rules.d/99-${MODULE_NAME}.rules"

echo "Creating udev rule at: $UDEV_RULE"

cat <<EOF > "$UDEV_RULE"
KERNEL=="$MODULE_NAME", GROUP="$GROUP_TO_USE", MODE="0660"
EOF

chmod 644 "$UDEV_RULE"

# --- 6. Reload udev ---
echo "Reloading udev rules..."
udevadm control --reload-rules
udevadm trigger

# --- 7. Configure auto-load ---
CONF_FILE="/etc/modules-load.d/${MODULE_NAME}.conf"
echo "$MODULE_NAME" > "$CONF_FILE"
chmod 644 "$CONF_FILE"

echo "--- Loading module now ---"
modprobe "$MODULE_NAME" || echo "Module may require reboot to load."

echo ""
echo "> Installation complete!"
echo "> Device will belong to group '$GROUP_TO_USE' (rw-rw----)"
echo ""
echo "If you need access without sudo, add your user to this group:"
echo "    sudo usermod -aG $GROUP_TO_USE \$USER"
echo ""
echo "Check device:"
echo "    ls -l /dev/$MODULE_NAME"
